<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>15-Day Backend Bootcamp Tracker</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>15-Day Backend Engineering Bootcamp</h1>
            <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;">
                <span id="syncStatus">Synced</span> | 
                <span style="font-size: 0.85em;">Device ID: <span id="userIdDisplay"></span></span>
            </p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="completedDays">0</div>
                <div class="stat-label">Days Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalHours">0</div>
                <div class="stat-label">Hours Invested</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completionRate">0%</div>
                <div class="stat-label">Completion Rate</div>
            </div>
        </div>

        <div class="controls">
            <div class="progress-container">
                <div class="progress-label">Overall Progress</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table id="bootcampTable">
                <thead>
                    <tr>
                        <th>Day</th>
                        <th>Topic</th>
                        <th>Key Tasks</th>
                        <th>Free Resources</th>
                        <th>Time</th>
                        <th>Done</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const bootcampData = [
            {
                day: "Day 0",
                topic: "Setup & Preparation",
                tasks: ["Install Java JDK 17+", "Install IntelliJ IDEA", "Install PostgreSQL", "Install Postman", "Install Git", "Install Docker", "Create GitHub account", "Create Railway account", "Create AWS Free Tier"],
                resources: [
                    { name: "Java JDK", url: "https://adoptium.net/" },
                    { name: "IntelliJ IDEA", url: "https://www.jetbrains.com/idea/download/" }
                ],
                time: "2-3 hrs"
            },
            {
                day: "Day 1",
                topic: "Java OOP Fundamentals",
                tasks: ["Learn Classes & Objects", "Study Inheritance & Polymorphism", "Understand Encapsulation", "Master Exception Handling", "Build Banking System project", "Push to GitHub: day1-java-oop"],
                resources: [
                    { name: "Java OOP - Mosh", url: "https://www.youtube.com/watch?v=xk4_1vDrzzo" },
                    { name: "Java Full Course - Bro Code", url: "https://www.youtube.com/watch?v=xk4_1vDrzzo" }
                ],
                time: "5-6 hrs"
            },
            {
                day: "Day 2",
                topic: "SOLID Principles",
                tasks: ["Study all 5 SOLID principles", "Refactor Day 1 code with SOLID", "Implement Factory Pattern", "Implement Strategy Pattern", "Create UML diagram", "Push to GitHub: day2-solid"],
                resources: [
                    { name: "SOLID - Web Dev Simplified", url: "https://www.youtube.com/watch?v=_jDNAf3CzeY" },
                    { name: "Design Patterns - Mosh", url: "https://www.youtube.com/watch?v=NU_1StN5Tkk" }
                ],
                time: "5-6 hrs"
            },
            {
                day: "Day 3",
                topic: "Git & Version Control",
                tasks: ["Complete Learn Git Branching", "Practice branching & merging", "Create 3 feature branches", "Resolve merge conflicts", "Create 3 Pull Requests", "Push 15+ commits"],
                resources: [
                    { name: "Git & GitHub - freeCodeCamp", url: "https://www.youtube.com/watch?v=RGOj5yH7evk" },
                    { name: "Learn Git Branching", url: "https://learngitbranching.js.org/" }
                ],
                time: "4-5 hrs"
            },
            {
                day: "Day 4",
                topic: "HTTP & REST API Design",
                tasks: ["Study HTTP methods & status codes", "Learn REST principles", "Design 11 banking endpoints", "Document request/response", "Define error responses", "Push API spec to GitHub"],
                resources: [
                    { name: "REST API - Telusko", url: "https://www.youtube.com/watch?v=qVTAB8Z2VmA" },
                    { name: "HTTP Crash Course", url: "https://www.youtube.com/watch?v=iYM2zFP3Zn0" }
                ],
                time: "4-5 hrs"
            },
            {
                day: "Day 5",
                topic: "Spring Boot Setup",
                tasks: ["Use Spring Initializr", "Set up project structure", "Learn key annotations", "Create 3 test endpoints", "Configure application.yml", "Run on localhost:8080"],
                resources: [
                    { name: "Spring Boot - Amigoscode", url: "https://www.youtube.com/watch?v=9SGDpanrc8U" },
                    { name: "Spring Boot - Java Brains", url: "https://www.youtube.com/watch?v=vtPkZShrvXQ" }
                ],
                time: "5-6 hrs"
            },
            {
                day: "Day 6",
                topic: "Building REST APIs",
                tasks: ["Implement 5 CRUD endpoints", "Add request validation", "Create global exception handler", "Build Account Management API", "Test with Postman", "Export Postman collection"],
                resources: [
                    { name: "Spring REST API - Amigoscode", url: "https://www.youtube.com/watch?v=9SGDpanrc8U" },
                    { name: "Exception Handling - Daily Code Buffer", url: "https://www.youtube.com/watch?v=PzK4ZXa2Tbc" }
                ],
                time: "6-7 hrs"
            },
            {
                day: "Day 7",
                topic: "SQL & Database Design",
                tasks: ["Complete SQLBolt exercises", "Design 3 tables with relationships", "Write 20+ SQL queries", "Create ER diagram", "Practice JOINs & aggregations", "Push schema to GitHub"],
                resources: [
                    { name: "SQL Full Course - freeCodeCamp", url: "https://www.youtube.com/watch?v=HXV3zeQKqGY" },
                    { name: "SQLBolt Interactive", url: "https://sqlbolt.com/" }
                ],
                time: "6-7 hrs"
            },
            {
                day: "Day 8",
                topic: "Spring Boot + PostgreSQL",
                tasks: ["Configure PostgreSQL connection", "Create JPA entities", "Implement repositories", "Build service layer with transactions", "Implement transferMoney()", "Test with database"],
                resources: [
                    { name: "Spring Data JPA - Daily Code Buffer", url: "https://www.youtube.com/watch?v=2KqaR37w7w8" },
                    { name: "JPA & Hibernate - Java Brains", url: "https://www.youtube.com/watch?v=8Gv6s1i8j_Y" }
                ],
                time: "7-8 hrs"
            },
            {
                day: "Day 9",
                topic: "Authentication & Security",
                tasks: ["Add Spring Security", "Implement JWT Service", "Create login/register endpoints", "Hash passwords with BCrypt", "Add role-based access control", "Test auth flow"],
                resources: [
                    { name: "Spring Security + JWT - Amigoscode", url: "https://www.youtube.com/watch?v=VVn9OG9nfH0" },
                    { name: "JWT Explained", url: "https://www.youtube.com/watch?v=7Q17ubqLfaM" }
                ],
                time: "7-8 hrs"
            },
            {
                day: "Day 10",
                topic: "Testing & Debugging",
                tasks: ["Write 15-20 unit tests", "Write integration tests", "Test controllers with MockMvc", "Test services with Mockito", "Achieve 80%+ coverage", "Create Postman test scripts"],
                resources: [
                    { name: "JUnit Testing - Amigoscode", url: "https://www.youtube.com/watch?v=Geq60OVyBPg" },
                    { name: "Mockito Tutorial - Java Brains", url: "https://www.youtube.com/watch?v=d2FBSt0tCsI" }
                ],
                time: "6-7 hrs"
            },
            {
                day: "Day 11",
                topic: "System Design Basics",
                tasks: ["Study load balancers", "Learn caching strategies", "Understand horizontal scaling", "Design a scalable system", "Create architecture diagram", "Document design decisions"],
                resources: [
                    { name: "System Design - ByteByteGo", url: "https://www.youtube.com/watch?v=FSR1s2b-l_I" },
                    { name: "System Design - Gaurav Sen", url: "https://www.youtube.com/watch?v=0163cssUxLA" }
                ],
                time: "5-6 hrs"
            },
            {
                day: "Day 12",
                topic: "Cloud Basics (AWS)",
                tasks: ["Sign up AWS Free Tier", "Learn EC2, S3, RDS basics", "Upload file to S3", "Create RDS PostgreSQL instance", "Connect to RDS from local", "Document with screenshots"],
                resources: [
                    { name: "AWS Basics - freeCodeCamp", url: "https://www.youtube.com/watch?v=ulprqHHWlng" },
                    { name: "AWS for Beginners - TechWorld", url: "https://www.youtube.com/watch?v=JIbIYCM48to" }
                ],
                time: "5-6 hrs"
            },
            {
                day: "Day 13",
                topic: "Docker & Deployment",
                tasks: ["Create Dockerfile", "Create docker-compose.yml", "Build & run containers", "Deploy to Railway/Render", "Get public URL", "Test deployed API"],
                resources: [
                    { name: "Docker Tutorial - TechWorld", url: "https://www.youtube.com/watch?v=3c-iBn73dDE" },
                    { name: "Docker - freeCodeCamp", url: "https://www.youtube.com/watch?v=fqMOX6JJhGo" }
                ],
                time: "6-7 hrs"
            },
            {
                day: "Day 14",
                topic: "CI/CD with GitHub Actions",
                tasks: ["Create GitHub Actions workflow", "Set up automated testing", "Configure build pipeline", "Add status badge", "Test workflow runs", "Push to GitHub"],
                resources: [
                    { name: "GitHub Actions - freeCodeCamp", url: "https://www.youtube.com/watch?v=R8_veQiYBjI" },
                    { name: "CI/CD Explained - TechWorld", url: "https://www.youtube.com/watch?v=scEDHsr3APg" }
                ],
                time: "4-5 hrs"
            },
            {
                day: "Day 15",
                topic: "Final Project - Complete Banking System",
                tasks: ["Build customer management", "Build account management", "Implement all transactions", "Add JWT auth", "Write 20+ tests", "Deploy to production", "Create professional README"],
                resources: [
                    { name: "Full Banking App - Bouali Ali", url: "https://www.youtube.com/watch?v=t5hPpPSY8cM" }
                ],
                time: "8-10 hrs"
            }
        ];

        const timeMap = {
            "2-3 hrs": 2.5,
            "4-5 hrs": 4.5,
            "5-6 hrs": 5.5,
            "6-7 hrs": 6.5,
            "7-8 hrs": 7.5,
            "8-10 hrs": 9
        };

        // Supabase Configuration
        const SUPABASE_URL = 'https://aqjjgmmvviozmedjgxdy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxampnbW12dmlvem1lZGpneGR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMjA5MTUsImV4cCI6MjA3Njg5NjkxNX0.XCQQfVAGDTnDqC4W6RHMd8Rmj3C8UyFUmE-S18JVLWk';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Generate or retrieve unique user ID for this device
        function getUserId() {
            let userId = localStorage.getItem('bootcamp_user_id');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('bootcamp_user_id', userId);
            }
            return userId;
        }
        
        const userId = getUserId();

        // SQLite Database Manager using sql.js (for offline/local storage)
        const StorageManager = {
            db: null,
            SQL: null,
            dbName: 'bootcamp_tracker.db',
            
            async init() {
                try {
                    // Initialize SQL.js
                    this.SQL = await initSqlJs({
                        locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/${file}`
                    });
                    
                    // Try to load existing database from IndexedDB
                    const savedDb = await this.loadFromIndexedDB();
                    
                    if (savedDb) {
                        this.db = new this.SQL.Database(savedDb);
                    } else {
                        // Create new database
                        this.db = new this.SQL.Database();
                        this.createTables();
                    }
                    
                    return this.db;
                } catch (error) {
                    console.error('SQL.js initialization failed:', error);
                    throw error;
                }
            },
            
            createTables() {
                this.db.run(`
                    CREATE TABLE IF NOT EXISTS completed_days (
                        day_index INTEGER PRIMARY KEY,
                        completed_at TEXT NOT NULL
                    )
                `);
                
                this.db.run(`
                    CREATE TABLE IF NOT EXISTS completed_tasks (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        day_index INTEGER NOT NULL,
                        task_index INTEGER NOT NULL,
                        completed_at TEXT NOT NULL,
                        UNIQUE(day_index, task_index)
                    )
                `);
                
                this.db.run(`
                    CREATE TABLE IF NOT EXISTS metadata (
                        key TEXT PRIMARY KEY,
                        value TEXT NOT NULL,
                        updated_at TEXT NOT NULL
                    )
                `);
                
                this.saveToIndexedDB();
            },
            
            async loadFromIndexedDB() {
                return new Promise((resolve) => {
                    const request = indexedDB.open('SQLiteStorage', 1);
                    
                    request.onerror = () => resolve(null);
                    request.onsuccess = () => {
                        const db = request.result;
                        if (!db.objectStoreNames.contains('files')) {
                            resolve(null);
                            return;
                        }
                        const transaction = db.transaction(['files'], 'readonly');
                        const store = transaction.objectStore('files');
                        const getRequest = store.get(this.dbName);
                        getRequest.onsuccess = () => {
                            resolve(getRequest.result ? getRequest.result.data : null);
                        };
                        getRequest.onerror = () => resolve(null);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('files')) {
                            db.createObjectStore('files');
                        }
                    };
                });
            },
            
            async saveToIndexedDB() {
                if (!this.db) return;
                
                const data = this.db.export();
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('SQLiteStorage', 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        const db = request.result;
                        const transaction = db.transaction(['files'], 'readwrite');
                        const store = transaction.objectStore('files');
                        const putRequest = store.put({ name: this.dbName, data: data });
                        putRequest.onsuccess = () => resolve();
                        putRequest.onerror = () => reject(putRequest.error);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('files')) {
                            db.createObjectStore('files');
                        }
                    };
                });
            },
            
            async getCompletedDays() {
                // Try to get from Supabase first, fallback to local
                try {
                    const { data, error } = await supabase
                        .from('completed_days')
                        .select('day_index')
                        .eq('user_id', userId)
                        .order('day_index');
                    
                    if (!error && data) {
                        const days = data.map(row => row.day_index);
                        // Sync to local
                        await this.saveCompletedDaysLocal(days);
                        return days;
                    }
                } catch (error) {
                    console.log('Supabase sync failed, using local:', error);
                }
                
                // Fallback to local SQLite
                const result = this.db.exec('SELECT day_index FROM completed_days ORDER BY day_index');
                if (result.length === 0) return [];
                return result[0].values.map(row => row[0]);
            },
            
            async saveCompletedDays(days) {
                // Save to Supabase (cloud)
                try {
                    // Delete existing
                    await supabase
                        .from('completed_days')
                        .delete()
                        .eq('user_id', userId);
                    
                    // Insert new
                    if (days.length > 0) {
                        const records = days.map(dayIndex => ({
                            day_index: dayIndex,
                            user_id: userId
                        }));
                        
                        await supabase
                            .from('completed_days')
                            .insert(records);
                    }
                } catch (error) {
                    console.error('Failed to sync to cloud:', error);
                }
                
                // Also save locally
                await this.saveCompletedDaysLocal(days);
            },

            async saveCompletedDaysLocal(days) {
                // Clear existing
                this.db.run('DELETE FROM completed_days');
                
                // Insert new
                const stmt = this.db.prepare('INSERT INTO completed_days (day_index, completed_at) VALUES (?, ?)');
                const now = new Date().toISOString();
                days.forEach(dayIndex => {
                    stmt.run([dayIndex, now]);
                });
                stmt.free();
                
                await this.saveToIndexedDB();
            },
            
            async getCompletedTasks() {
                // Try to get from Supabase first, fallback to local
                try {
                    const { data, error } = await supabase
                        .from('completed_tasks')
                        .select('day_index, task_index')
                        .eq('user_id', userId)
                        .order('day_index, task_index');
                    
                    if (!error && data) {
                        const tasks = {};
                        data.forEach(row => {
                            const dayIndex = row.day_index;
                            const taskIndex = row.task_index;
                            if (!tasks[dayIndex]) {
                                tasks[dayIndex] = [];
                            }
                            tasks[dayIndex].push(taskIndex);
                        });
                        // Sync to local
                        await this.saveCompletedTasksLocal(tasks);
                        return tasks;
                    }
                } catch (error) {
                    console.log('Supabase sync failed, using local:', error);
                }
                
                // Fallback to local SQLite
                const result = this.db.exec('SELECT day_index, task_index FROM completed_tasks');
                if (result.length === 0) return {};
                
                const tasks = {};
                result[0].values.forEach(row => {
                    const dayIndex = row[0];
                    const taskIndex = row[1];
                    if (!tasks[dayIndex]) {
                        tasks[dayIndex] = [];
                    }
                    tasks[dayIndex].push(taskIndex);
                });
                
                return tasks;
            },
            
            async saveCompletedTasks(tasks) {
                // Save to Supabase (cloud)
                try {
                    // Delete existing
                    await supabase
                        .from('completed_tasks')
                        .delete()
                        .eq('user_id', userId);
                    
                    // Insert new
                    const records = [];
                    Object.keys(tasks).forEach(dayIndex => {
                        tasks[dayIndex].forEach(taskIndex => {
                            records.push({
                                day_index: parseInt(dayIndex),
                                task_index: parseInt(taskIndex),
                                user_id: userId
                            });
                        });
                    });
                    
                    if (records.length > 0) {
                        await supabase
                            .from('completed_tasks')
                            .insert(records);
                    }
                } catch (error) {
                    console.error('Failed to sync to cloud:', error);
                }
                
                // Also save locally
                await this.saveCompletedTasksLocal(tasks);
            },

            async saveCompletedTasksLocal(tasks) {
                // Clear existing
                this.db.run('DELETE FROM completed_tasks');
                
                // Insert new
                const stmt = this.db.prepare('INSERT INTO completed_tasks (day_index, task_index, completed_at) VALUES (?, ?, ?)');
                const now = new Date().toISOString();
                
                Object.keys(tasks).forEach(dayIndex => {
                    tasks[dayIndex].forEach(taskIndex => {
                        stmt.run([parseInt(dayIndex), parseInt(taskIndex), now]);
                    });
                });
                stmt.free();
                
                await this.saveToIndexedDB();
            },
            
            async exportData() {
                const [days, tasks] = await Promise.all([
                    this.getCompletedDays(),
                    this.getCompletedTasks()
                ]);
                return { completedDays: days, completedTasks: tasks };
            },
            
            async importData(data) {
                await Promise.all([
                    this.saveCompletedDays(data.completedDays || []),
                    this.saveCompletedTasks(data.completedTasks || {})
                ]);
            },
            
            async clearAll() {
                this.db.run('DELETE FROM completed_days');
                this.db.run('DELETE FROM completed_tasks');
                await this.saveToIndexedDB();
            },
            
            // Export database as SQLite file
            async exportDatabase() {
                const data = this.db.export();
                return data;
            },
            
            // Import database from SQLite file
            async importDatabase(arrayBuffer) {
                this.db = new this.SQL.Database(new Uint8Array(arrayBuffer));
                await this.saveToIndexedDB();
            }
        };

        // Initialize storage and load data
        let completedDays = [];
        let completedTasks = {};
        let storageReady = false;

        // Real-time sync setup
        function setupRealtimeSync() {
            // Subscribe to changes in completed_days
            supabase
                .channel('completed_days_changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'completed_days', filter: `user_id=eq.${userId}` },
                    async (payload) => {
                        console.log('Real-time update received:', payload);
                        // Reload data from cloud
                        completedDays = await StorageManager.getCompletedDays();
                        completedTasks = await StorageManager.getCompletedTasks();
                        renderTable();
                    }
                )
                .subscribe();

            // Subscribe to changes in completed_tasks
            supabase
                .channel('completed_tasks_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'completed_tasks', filter: `user_id=eq.${userId}` },
                    async (payload) => {
                        console.log('Real-time update received:', payload);
                        // Reload data from cloud
                        completedDays = await StorageManager.getCompletedDays();
                        completedTasks = await StorageManager.getCompletedTasks();
                        renderTable();
                    }
                )
                .subscribe();
        }

        // Initialize storage on page load
        let syncStatus = 'offline';
        
        // Initialize immediately with localStorage fallback
        (async function initialize() {
            try {
                // Try to load from localStorage first (immediate)
                const savedDays = localStorage.getItem('completedDays');
                const savedTasks = localStorage.getItem('completedTasks');
                
                if (savedDays) {
                    completedDays = JSON.parse(savedDays);
                }
                if (savedTasks) {
                    completedTasks = JSON.parse(savedTasks);
                }
                
                // Render immediately with cached data
                renderTable();
                
                // Then try to initialize SQLite and sync with cloud
                try {
                    await StorageManager.init();
                    storageReady = true;
                    
                    // Load data (will try cloud first, fallback to local)
                    const cloudDays = await StorageManager.getCompletedDays();
                    const cloudTasks = await StorageManager.getCompletedTasks();
                    
                    // Merge cloud data with local (cloud takes precedence)
                    if (cloudDays.length > 0) completedDays = cloudDays;
                    if (Object.keys(cloudTasks).length > 0) completedTasks = cloudTasks;
                    
                    // Save merged data
                    await StorageManager.saveCompletedDays(completedDays);
                    await StorageManager.saveCompletedTasks(completedTasks);
                    
                    // Also save to localStorage for immediate access
                    localStorage.setItem('completedDays', JSON.stringify(completedDays));
                    localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
                    
                    // Setup real-time sync
                    setupRealtimeSync();
                    syncStatus = 'online';
                    updateSyncStatus();
                    
                    renderTable();
                } catch (dbError) {
                    console.error('Database initialization failed:', dbError);
                    storageReady = false;
                    syncStatus = 'offline';
                    updateSyncStatus();
                    // Keep using localStorage
                }
                
                // Display user ID
                const userIdDisplay = document.getElementById('userIdDisplay');
                if (userIdDisplay) {
                    userIdDisplay.textContent = userId.substring(0, 20) + '...';
                }
            } catch (error) {
                console.error('Initialization failed:', error);
                storageReady = false;
                syncStatus = 'offline';
                updateSyncStatus();
            }
        })();

        // Update sync status indicator
        function updateSyncStatus() {
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.textContent = syncStatus === 'online' ? 'Synced' : 'Offline';
                statusEl.style.color = syncStatus === 'online' ? '#28a745' : '#dc3545';
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            bootcampData.forEach((day, index) => {
                const row = document.createElement('tr');
                const isCompleted = completedDays.includes(index);
                if (isCompleted) row.classList.add('completed-row');

                const dayCompletedTasks = completedTasks[index] || [];
                const allTasksCompleted = day.tasks.length > 0 && dayCompletedTasks.length === day.tasks.length;
                
                // Auto-update day completion based on tasks (but don't save here to avoid loops)
                // The actual saving happens in toggleTask/toggleDay functions

                row.innerHTML = `
                    <td class="day-cell">${day.day}</td>
                    <td class="topic-cell">${day.topic}</td>
                    <td class="tasks-cell">
                        <ul>
                            ${day.tasks.map((task, taskIndex) => {
                                const isTaskCompleted = dayCompletedTasks.includes(taskIndex);
                                return `<li class="task-item" onclick="toggleTask(${index}, ${taskIndex})">
                                    <input type="checkbox" 
                                           class="task-checkbox" 
                                           ${isTaskCompleted ? 'checked' : ''}
                                           onclick="event.stopPropagation(); toggleTask(${index}, ${taskIndex})">
                                    <span class="task-text ${isTaskCompleted ? 'task-completed' : ''}">${task}</span>
                                </li>`;
                            }).join('')}
                        </ul>
                    </td>
                    <td class="resources-cell">
                        ${day.resources.map(res => 
                            `<a href="${res.url}" target="_blank" class="resource-link">${res.name}</a><br>`
                        ).join('')}
                    </td>
                    <td class="time-cell">${day.time}</td>
                    <td class="checkbox-cell">
                        <input type="checkbox" 
                               class="checkbox-custom" 
                               ${allTasksCompleted ? 'checked' : ''}
                               onchange="toggleDay(${index})">
                    </td>
                `;

                tbody.appendChild(row);
            });

            updateStats();
        }

        async function toggleTask(dayIndex, taskIndex) {
            if (!completedTasks[dayIndex]) {
                completedTasks[dayIndex] = [];
            }
            
            const taskArray = completedTasks[dayIndex];
            if (taskArray.includes(taskIndex)) {
                // Uncheck task
                completedTasks[dayIndex] = taskArray.filter(t => t !== taskIndex);
            } else {
                // Check task
                completedTasks[dayIndex].push(taskIndex);
            }
            
            // Clean up empty arrays
            if (completedTasks[dayIndex].length === 0) {
                delete completedTasks[dayIndex];
            }
            
            // Update day completion status
            const dayCompletedTasks = completedTasks[dayIndex] || [];
            const allTasksCompleted = bootcampData[dayIndex].tasks.length > 0 && 
                                     dayCompletedTasks.length === bootcampData[dayIndex].tasks.length;
            
            if (allTasksCompleted && !completedDays.includes(dayIndex)) {
                completedDays.push(dayIndex);
            } else if (!allTasksCompleted && completedDays.includes(dayIndex)) {
                completedDays = completedDays.filter(d => d !== dayIndex);
            }
            
            // Save immediately to localStorage
            localStorage.setItem('completedDays', JSON.stringify(completedDays));
            localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
            
            // Save to database if ready
            if (storageReady) {
                try {
                    await StorageManager.saveCompletedDays(completedDays);
                    await StorageManager.saveCompletedTasks(completedTasks);
                } catch (error) {
                    console.error('Failed to save to database:', error);
                }
            }
            
            renderTable();
        }

        async function toggleDay(index) {
            const dayCompletedTasks = completedTasks[index] || [];
            const allTasksCompleted = bootcampData[index].tasks.length > 0 && 
                                     dayCompletedTasks.length === bootcampData[index].tasks.length;
            
            if (allTasksCompleted) {
                // If all tasks are done, uncheck day (which will uncheck all tasks)
                if (completedDays.includes(index)) {
                    completedDays = completedDays.filter(d => d !== index);
                }
                // Uncheck all tasks
                delete completedTasks[index];
            } else {
                // If not all tasks done, check all tasks
                completedTasks[index] = bootcampData[index].tasks.map((_, i) => i);
                if (!completedDays.includes(index)) {
                    completedDays.push(index);
                }
            }
            
            // Save immediately to localStorage
            localStorage.setItem('completedDays', JSON.stringify(completedDays));
            localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
            
            // Save to database if ready
            if (storageReady) {
                try {
                    await StorageManager.saveCompletedDays(completedDays);
                    await StorageManager.saveCompletedTasks(completedTasks);
                } catch (error) {
                    console.error('Failed to save to database:', error);
                }
            }
            
            renderTable();
        }

        function updateStats() {
            const totalDays = bootcampData.length;
            const completed = completedDays.length;
            
            // Calculate total tasks and completed tasks
            let totalTasks = 0;
            let completedTasksCount = 0;
            
            bootcampData.forEach((day, index) => {
                totalTasks += day.tasks.length;
                const dayCompletedTasks = completedTasks[index] || [];
                completedTasksCount += dayCompletedTasks.length;
            });
            
            // Calculate percentage based on tasks (more accurate)
            const taskPercentage = totalTasks > 0 ? Math.round((completedTasksCount / totalTasks) * 100) : 0;
            const dayPercentage = Math.round((completed / totalDays) * 100);

            // Calculate total hours based on completed days
            const totalHours = completedDays.reduce((sum, index) => {
                return sum + timeMap[bootcampData[index].time];
            }, 0);

            document.getElementById('completedDays').textContent = completed;
            document.getElementById('totalHours').textContent = Math.round(totalHours);
            document.getElementById('completionRate').textContent = taskPercentage + '%';
            
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = taskPercentage + '%';
            progressFill.textContent = taskPercentage + '%';
        }


        // Initialize - render will be called after storage is ready
        if (!storageReady) {
            // Show loading state
            document.getElementById('tableBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">Loading...</td></tr>';
        }
    </script>
</body>
</html>